# 知识库Agent系统项目文档

## 1. 项目概述

### 1.1 项目简介
知识库Agent系统是一个基于LangGraph和FastAPI构建的智能问答平台，采用前后端分离架构。系统允许用户上传文档到知识库，然后通过自然语言查询与这些文档交互，获取基于知识库的智能回答。该系统结合了现代大语言模型与知识库检索技术，提供上下文感知的智能回答服务。

### 1.2 项目目标
- 构建一个易用的知识库管理系统
- 提供高质量的自然语言问答能力
- 支持多种文档格式的知识库建设
- 实现流畅的用户交互体验
- 确保系统的可扩展性和可维护性

### 1.3 技术栈
- **后端**：Python, FastAPI, LangGraph, LangChain, SQLAlchemy, OpenAI API
- **前端**：TypeScript, Vite, React, Semi Design UI组件库
- **数据库**：PostgreSQL (通过SQLAlchemy ORM访问)
- **向量存储**：用于文档存储和相似性检索

## 2. 系统架构

### 2.1 整体架构
系统采用前后端分离的微服务架构，主要分为以下几个部分：
- **前端应用**：用户界面，负责展示和交互
- **后端API服务**：处理业务逻辑和数据访问
- **知识库Agent**：基于LangGraph构建的智能问答系统
- **数据库**：存储用户、会话、消息等结构化数据
- **向量存储**：存储文档向量化表示，支持相似性搜索

### 2.2 项目目录结构

```
notebook-ai/
│
├── notebook-backend/           # 后端项目
│   ├── app/                    # 主应用代码
│   │   ├── agents/             # Agent实现
│   │   ├── auth/               # 认证相关
│   │   ├── core/               # 核心配置
│   │   ├── models/             # 数据模型
│   │   ├── routers/            # API路由
│   │   ├── services/           # 业务服务
│   │   └── utils/              # 工具函数
│   ├── migrations/             # 数据库迁移
│   └── requirements.txt        # 依赖管理
│
├── notebook-frontend/          # 前端项目
│   ├── public/                 # 静态资源
│   ├── src/                    # 源代码
│   │   ├── api/                # API客户端
│   │   ├── assets/             # 资源文件
│   │   ├── components/         # UI组件
│   │   ├── contexts/           # React上下文
│   │   ├── pages/              # 页面组件
│   │   ├── types/              # 类型定义
│   │   └── utils/              # 工具函数
│   └── package.json            # 依赖管理
│
└── doc/                        # 项目文档
```

### 2.3 数据流设计
```
用户请求 → 前端应用 → 后端API → Agent处理 → 知识库检索 → 生成回答 → 返回前端 → 展示给用户
```

## 3. 功能模块详解

### 3.1 用户认证模块
**功能**：
- 用户注册和登录
- JWT令牌管理
- 用户权限控制
- 会话管理

**核心文件**：
- `app/routers/auth.py`：认证相关API
- `app/auth/`：认证实现
- `app/models/user.py`：用户模型

**API端点**：
- POST `/api/auth/token`：获取访问令牌
- POST `/api/auth/register`：注册新用户
- GET `/api/auth/me`：获取当前用户信息

### 3.2 知识库Agent模块

**功能**：
- 基于LangGraph构建的智能会话流
- 上下文感知的自然语言理解
- 结合知识库的回答生成
- 流式响应支持

**核心文件**：
- `app/agents/knowledge_agent.py`：Agent核心实现
- `app/routers/agents.py`：Agent相关API

**工作流程**：
1. 接收用户查询
2. 从知识库检索相关文档
3. 构建包含检索结果的提示
4. 调用语言模型生成回答
5. 流式返回结果

**API端点**：
- POST `/api/agents/query`：查询Agent
- GET `/api/agents/config`：获取Agent配置
- POST `/api/agents/config`：更新Agent配置

### 3.3 文档管理模块

**功能**：
- 文档上传和存储
- 文本提取和处理
- 文档向量化
- 文档检索和管理

**核心文件**：
- `app/routers/documents.py`：文档相关API
- `app/services/document_service.py`：文档服务
- `app/models/document.py`：文档模型

**API端点**：
- POST `/api/documents/upload`：上传文档
- GET `/api/documents`：获取文档列表
- GET `/api/documents/{id}`：获取文档详情
- DELETE `/api/documents/{id}`：删除文档

### 3.4 聊天会话模块

**功能**：
- 会话创建和管理
- 消息存储和检索
- 会话历史记录

**核心文件**：
- `app/routers/chat.py`：聊天相关API
- `app/services/chat_service.py`：聊天服务
- `app/models/chat.py`：聊天模型

**API端点**：
- GET `/api/chat/sessions`：获取会话列表
- POST `/api/chat/sessions`：创建新会话
- GET `/api/chat/sessions/{id}/messages`：获取会话消息
- POST `/api/chat/sessions/{id}/messages`：添加新消息

### 3.5 前端界面模块

**功能**：
- 聊天界面
- 文档管理界面
- 用户认证界面
- 响应式设计

**核心文件**：
- `src/components/SemiChat.tsx`：聊天组件
- `src/components/DocumentManager.tsx`：文档管理组件
- `src/components/DocumentUploader.tsx`：文档上传组件
- `src/api/api.ts`：API客户端

## 4. 技术实现详情

### 4.1 知识库Agent实现

Agent基于LangGraph构建工作流图，主要包含以下节点：
- **检索上下文**：从向量数据库获取相关文档
- **生成回答**：使用语言模型生成回答

Agent状态包含：
```python
class AgentState(TypedDict):
    session_id: str
    query: str
    context: Dict[str, Any]
    answer: str
    sources: List[Dict[str, Any]]
    metadata: Dict[str, Any]
```

工作流程：
1. 用户查询进入Agent
2. 检索上下文节点从知识库获取相关文档
3. 生成回答节点使用检索到的文档和历史对话生成回答
4. 返回结果，包含答案和来源文档

### 4.2 向量存储与检索

系统使用向量数据库存储文档的向量化表示，支持高效的语义相似性搜索：

1. 文档处理流程：
   - 文档上传
   - 文本提取
   - 文本分块
   - 向量化（使用嵌入模型）
   - 存储到向量数据库

2. 检索流程：
   - 查询向量化
   - 相似性搜索
   - 返回最相关的文档片段

### 4.3 流式响应实现

系统支持流式响应，提升用户体验：

**后端实现**：
- 使用FastAPI的`StreamingResponse`
- LangGraph异步流式生成
- 基于SSE (Server-Sent Events)的数据传输

**前端实现**：
- 使用Fetch API处理SSE流
- React状态管理展示实时更新
- 流式内容的分块渲染

### 4.4 前端组件设计

前端使用React和Semi Design UI组件库，主要组件包括：

1. **SemiChat**：聊天界面主组件
   - 消息列表显示
   - 消息发送处理
   - 流式响应接收与渲染

2. **DocumentManager**：文档管理组件
   - 文档列表展示
   - 文档搜索和过滤
   - 文档元数据展示

3. **DocumentUploader**：文档上传组件
   - 文件选择和上传
   - 上传进度显示
   - 元数据编辑

4. **ResponseBlock系列组件**：
   - 分析块渲染
   - 思考块渲染
   - 答案块渲染
   - Markdown内容渲染

## 5. 部署与运维

### 5.1 环境要求
- Python 3.9+
- Node.js 16+
- PostgreSQL 13+
- 向量数据库（兼容PostgreSQL的扩展或独立部署）

### 5.2 部署流程
1. 后端部署：
   ```bash
   cd notebook-backend
   pip install -r requirements.txt
   cp .env.example .env  # 配置环境变量
   python -m uvicorn app.main:app
   ```

2. 前端部署：
   ```bash
   cd notebook-frontend
   npm install
   npm run build
   # 使用Nginx或其他静态文件服务器部署dist目录
   ```

### 5.3 性能优化
- 使用异步IO提高后端性能
- 实现查询缓存减少重复计算
- 文档分块策略优化检索效率
- 前端延迟加载和组件懒加载

## 6. 未来拓展计划

### 6.1 功能拓展
- 支持更多文档格式
- 增强文档处理功能
- 添加多语言支持
- 实现用户反馈机制

### 6.2 技术优化
- 引入更高级的检索模型
- 优化向量存储性能
- 提升流式响应体验
- 增强安全性和隐私保护

## 7. 总结

知识库Agent系统是一个现代化的智能问答平台，结合了最新的大语言模型与知识库检索技术，为用户提供高质量的问答服务。系统的模块化设计和前后端分离架构确保了良好的可扩展性和可维护性，为未来功能扩展奠定了坚实基础。

通过LangGraph构建的Agent工作流使系统能够提供上下文感知的智能回答，而流式响应设计则大幅提升了用户体验。整体而言，该系统代表了现代AI应用开发的优秀实践。 