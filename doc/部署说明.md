# 知识库Agent系统部署说明

## 系统要求

### 硬件要求
- **CPU**: 2核心及以上
- **内存**: 最低4GB，推荐8GB以上
- **存储**: 最低20GB可用空间

### 软件要求
- **操作系统**: Linux / MacOS / Windows
- **Python**: 版本3.9+
- **Node.js**: 版本16+
- **PostgreSQL**: 版本13+
- **向量数据库**: 兼容PostgreSQL的向量扩展或独立部署的向量数据库

## 1. 环境准备

### 1.1 安装Python环境

确保已安装Python 3.9或更高版本：

```bash
# 查看Python版本
python --version

# 如果需要安装，推荐使用pyenv或官方安装包
# Ubuntu/Debian安装示例
sudo apt update
sudo apt install python3.9 python3.9-venv python3.9-dev
```

### 1.2 安装Node.js环境

确保已安装Node.js 16或更高版本：

```bash
# 查看Node.js版本
node --version

# 如果需要安装，推荐使用nvm或官方安装包
# 使用nvm安装Node.js 16
nvm install 16
nvm use 16
```

### 1.3 安装PostgreSQL数据库

安装并配置PostgreSQL 13或更高版本：

```bash
# Ubuntu/Debian安装示例
sudo apt update
sudo apt install postgresql-13

# 启动数据库服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库和用户
sudo -u postgres psql -c "CREATE DATABASE notebook_db;"
sudo -u postgres psql -c "CREATE USER notebook_user WITH ENCRYPTED PASSWORD 'your_password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE notebook_db TO notebook_user;"
```

### 1.4 安装向量数据库扩展（可选）

如果使用PostgreSQL的向量扩展（如pgvector）：

```bash
# 安装pgvector扩展
sudo apt install postgresql-13-pgvector

# 启用扩展
sudo -u postgres psql -d notebook_db -c "CREATE EXTENSION vector;"
```

## 2. 后端部署

### 2.1 获取代码

```bash
# 克隆代码仓库（如果使用Git）
git clone https://your-repository-url.git
cd notebook-ai
```

### 2.2 配置后端环境

```bash
# 进入后端目录
cd notebook-backend

# 创建并激活虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/MacOS
# 或
venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2.3 配置环境变量

创建`.env`文件，配置必要的环境变量：

```bash
cp .env.example .env
```

编辑`.env`文件，填入以下配置：

```
# API配置
DEBUG=False
PROJECT_NAME=知识库Agent系统
VERSION=0.1.0
SECRET_KEY=your_secret_key_here
CORS_ORIGINS=["http://localhost:3000","https://your-domain.com"]

# 数据库配置
DATABASE_URL=postgresql://notebook_user:your_password@localhost/notebook_db

# OpenAI API配置
OPENAI_API_KEY=your_openai_api_key
OPENAI_API_BASE=https://api.openai.com/v1

# 向量存储配置
VECTOR_STORE_TYPE=postgres  # 或faiss, chroma等
VECTOR_STORE_URL=postgresql://notebook_user:your_password@localhost/notebook_db
EMBEDDING_MODEL=text-embedding-ada-002

# 日志配置
LOG_LEVEL=INFO
```

### 2.4 初始化数据库

```bash
# 初始化数据库表
python init_db.py

# 运行数据库迁移（如果使用Alembic）
alembic upgrade head
```

### 2.5 启动后端服务

开发环境：

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

生产环境：

```bash
# 使用启动脚本
chmod +x start.sh
./start.sh

# 或直接使用uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

推荐使用Nginx反向代理和Gunicorn作为WSGI服务器部署生产环境：

```bash
# 安装Gunicorn
pip install gunicorn

# 启动Gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
```

## 3. 前端部署

### 3.1 配置前端环境

```bash
# 进入前端目录
cd notebook-frontend

# 安装依赖
npm install
```

### 3.2 配置环境变量

创建`.env.local`文件，配置API地址：

```
NEXT_PUBLIC_API_URL=http://localhost:8000/api
```

### 3.3 开发环境启动

```bash
npm run dev
```

### 3.4 生产环境构建和部署

构建前端应用：

```bash
npm run build
```

使用Nginx部署构建后的应用：

```bash
# 安装Nginx
sudo apt install nginx

# 配置Nginx
sudo nano /etc/nginx/sites-available/notebook-frontend
```

Nginx配置示例：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    root /path/to/notebook-frontend/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用配置并重启Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/notebook-frontend /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 4. 系统维护

### 4.1 备份数据库

定期备份PostgreSQL数据库：

```bash
# 创建数据库备份
pg_dump -U notebook_user -d notebook_db -F c -f backup_$(date +%Y%m%d).dump

# 恢复备份
pg_restore -U notebook_user -d notebook_db backup_20230101.dump
```

### 4.2 日志管理

系统日志位于`notebook-backend/logs/`目录下，按日期分割。
可以使用logrotate配置日志轮转：

```bash
# 创建logrotate配置
sudo nano /etc/logrotate.d/notebook-backend

# 配置内容
/path/to/notebook-backend/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
}
```

### 4.3 更新系统

更新后端代码：

```bash
cd notebook-backend
git pull  # 如果使用Git
source venv/bin/activate
pip install -r requirements.txt  # 更新依赖
alembic upgrade head  # 更新数据库结构
sudo systemctl restart notebook-backend  # 如果使用systemd
```

更新前端代码：

```bash
cd notebook-frontend
git pull  # 如果使用Git
npm install  # 更新依赖
npm run build  # 重新构建
```

## 5. 使用systemd管理服务（推荐）

### 5.1 创建后端服务单元

```bash
sudo nano /etc/systemd/system/notebook-backend.service
```

服务单元内容：

```ini
[Unit]
Description=Notebook Backend Service
After=network.target postgresql.service

[Service]
User=www-data
Group=www-data
WorkingDirectory=/path/to/notebook-backend
ExecStart=/path/to/notebook-backend/venv/bin/gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000
Restart=always
RestartSec=5
SyslogIdentifier=notebook-backend

[Install]
WantedBy=multi-user.target
```

### 5.2 启用并启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable notebook-backend
sudo systemctl start notebook-backend
sudo systemctl status notebook-backend
```

## 6. 故障排除

### 6.1 检查服务状态

```bash
# 检查后端服务状态
sudo systemctl status notebook-backend

# 查看日志
sudo journalctl -u notebook-backend -f

# 查看应用日志
tail -f notebook-backend/logs/app.log
```

### 6.2 常见问题

#### 数据库连接错误

- 检查数据库是否正在运行：`sudo systemctl status postgresql`
- 检查数据库连接字符串是否正确
- 确认数据库用户有正确的权限

#### API连接错误

- 检查CORS配置是否正确
- 确认API地址配置正确
- 检查防火墙是否允许必要端口

#### OpenAI API错误

- 确认API密钥是否有效
- 检查网络连接是否可以访问OpenAI API
- 查看使用额度是否足够

## 7. 安全建议

- 使用HTTPS保护API和前端通信
- 定期更新密码和API密钥
- 限制数据库和API的访问范围
- 定期更新系统和依赖包
- 使用防火墙限制端口访问
- 配置适当的用户权限

## 8. 性能优化

- 调整数据库配置以适应服务器资源
- 配置适当的缓存策略
- 优化向量数据库查询性能
- 增加应用实例数量以处理更多并发请求
- 使用CDN加速前端静态资源 