# 文档处理任务流程实现计划 - 概览

## 总体架构

本文档描述了文档上传和处理流程的实现计划，主要基于Task和TaskDetail两个模型，通过Celery提供异步任务处理功能。整个流程包括：

1. 后端接收文件上传请求并保存到Minio
2. 创建Task记录文件处理任务
3. 通过Celery异步执行后续处理步骤
4. 为每个处理步骤创建TaskDetail记录并实时更新状态
5. 使用WebSocket向前端推送任务状态更新
6. 所有处理步骤完成后更新主Task状态

## 文件目录结构

### 后端 (`notebook-backend`)

```
notebook-backend/
├── app/
│   ├── api/
│   │   ├── endpoints/
│   │   │   ├── documents.py     # 文档相关API
│   │   │   └── tasks.py         # 任务相关API
│   │   ├── celery_tasks/
│   │   │   └── document_processing.py  # 文档处理Celery任务
│   │   ├── models/
│   │   │   ├── document.py          # 文档模型
│   │   │   └── task.py              # 任务和任务详情模型
│   │   ├── services/
│   │   │   ├── document_service.py  # 文档服务
│   │   │   ├── task_service.py      # 任务服务
│   │   │   ├── task_detail_service.py  # 任务详情服务
│   │   │   ├── storage_service.py   # 存储服务(Minio)
│   │   │   ├── vector_store_service.py # 向量存储服务
│   │   │   ├── text_extraction_service.py # 文本提取服务
│   │   │   ├── text_splitting_service.py # 文本分块服务
│   │   │   └── embedding_service.py # 嵌入向量服务
│   │   ├── websockets/
│   │   │   └── task_manager.py      # WebSocket任务状态管理
│   │   ├── config.py                # 应用配置
│   │   ├── database.py              # 数据库连接
│   │   └── main.py                  # 应用入口
```

### 前端 (`notebook-frontend`)

```
notebook-frontend/
├── src/
│   ├── api/
│   │   ├── documents.js         # 文档API调用
│   │   └── tasks.js             # 任务API调用
│   │   ├── components/
│   │   │   ├── DocumentUpload/      # 文档上传组件
│   │   │   │   └── FileUpload.jsx
│   │   │   └── TaskMonitor/         # 任务监控组件
│   │   │       └── TaskProgressMonitor.jsx
│   │   ├── hooks/
│   │   │   └── useWebSocket.js      # WebSocket钩子
│   │   ├── pages/
│   │   │   └── Documents/
│   │   │       └── Upload.jsx       # 文档上传页面
```

## 实现计划文档

详细的实现计划分为以下几个部分，可在相应文件中查看详细内容：

1. [数据模型实现计划](文档处理任务流程实现计划.md) - 包含TaskDetail模型定义及与Task的关联
2. [服务层实现计划](文档处理任务流程实现计划-服务层.md) - 包含各种服务的实现细节
3. [前端部分实现计划](文档处理任务流程实现计划-前端部分.md) - 包含前端组件和API调用的实现

## 处理流程步骤

1. **文件上传**
   - 前端：通过FileUpload组件上传文件
   - 后端：保存文件至临时目录，创建Document记录和Task记录

2. **Celery任务处理**
   - 创建多个任务步骤(TaskDetail)
   - 执行处理链：文件验证 -> 文本提取 -> 文本分块 -> 生成向量 -> 向量存储

3. **实时状态更新**
   - 每个步骤开始/完成时更新TaskDetail状态
   - 通过WebSocket向前端推送状态更新
   - 前端TaskProgressMonitor组件显示处理进度

4. **处理完成**
   - 所有步骤完成后更新主Task状态为完成
   - 更新Document状态为可用
   - 通过WebSocket通知前端处理完成

## 实现优先级

1. 首先实现TaskDetail数据模型和与Task的关联
2. 实现文件上传和Minio存储功能
3. 实现Celery任务和处理链
4. 实现WebSocket实时状态更新
5. 实现前端组件和页面 