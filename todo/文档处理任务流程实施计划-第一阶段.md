# 文档处理任务流程实施计划 - 第一阶段

## 第一阶段：数据模型与基础服务层实现

### 一、数据模型实现

#### 1. TaskDetail SQLAlchemy模型

**位置**: `notebook-backend/app/models/task.py`

```python
class TaskDetail(Base):
    """任务详情数据模型"""
    __tablename__ = "task_details"

    id = Column(Integer, primary_key=True, autoincrement=True)
    task_id = Column(String(36), ForeignKey("tasks.id"), nullable=True)
    step_name = Column(String(50), nullable=False)  # 步骤名称
    step_order = Column(Integer, nullable=False)  # 步骤顺序
    status = Column(String(20), nullable=False, default=TaskStatus.PENDING)  # 步骤状态
    progress = Column(Integer, nullable=False, default=0)  # 步骤进度（0-100）
    details = Column(JSON, nullable=True)  # 步骤详细信息
    error_message = Column(Text, nullable=True)  # 错误信息
    started_at = Column(DateTime, nullable=True)  # 开始时间
    completed_at = Column(DateTime, nullable=True)  # 完成时间
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)  # 创建时间
    
    # 与Task的关系
    task = relationship("Task", back_populates="task_details")

    # 添加索引
    __table_args__ = (
        Index('idx_task_details_task_id', 'task_id'),
        Index('idx_task_details_status', 'status'),
    )
```

#### 2. 修改Task模型添加关系

**位置**: `notebook-backend/app/models/task.py`

```python
class Task(Base):
    # 现有字段保持不变
    
    # 添加关系
    task_details = relationship("TaskDetail", back_populates="task", cascade="all, delete-orphan")
```

#### 3. Pydantic模型

**位置**: `notebook-backend/app/models/task.py`

```python
class TaskDetailBase(BaseModel):
    """任务详情基础模型"""
    step_name: str
    step_order: int
    status: str = TaskStatus.PENDING
    progress: int = 0
    details: Optional[Dict[str, Any]] = None
    error_message: Optional[str] = None

    model_config = ConfigDict(from_attributes=True)

class TaskDetailCreate(TaskDetailBase):
    """任务详情创建模型"""
    task_id: str

class TaskDetailUpdate(BaseModel):
    """任务详情更新模型"""
    status: Optional[str] = None
    progress: Optional[int] = None
    details: Optional[Dict[str, Any]] = None
    error_message: Optional[str] = None
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None

    model_config = ConfigDict(from_attributes=True)

class TaskDetailResponse(TaskDetailBase):
    """任务详情响应模型"""
    id: int
    task_id: str
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    created_at: datetime

    model_config = ConfigDict(from_attributes=True)
```

#### 4. 数据库迁移

```bash
# 生成迁移脚本
alembic revision --autogenerate -m "Add TaskDetail model"

# 应用迁移
alembic upgrade head
```

### 二、任务详情服务实现

**位置**: `notebook-backend/app/services/task_detail_service.py`

```python
from datetime import datetime
from typing import List, Dict, Any, Optional
from sqlalchemy.orm import Session
from app.models.task import TaskDetail, TaskStatus

class TaskDetailService:
    def __init__(self, db: Session):
        self.db = db

    def create_task_detail(self, task_id: str, step_name: str, step_order: int) -> TaskDetail:
        """创建任务详情记录"""
        task_detail = TaskDetail(
            task_id=task_id,
            step_name=step_name,
            step_order=step_order,
            status=TaskStatus.PENDING,
            progress=0
        )
        self.db.add(task_detail)
        self.db.commit()
        self.db.refresh(task_detail)
        return task_detail

    def update_task_detail(
        self, 
        task_detail_id: int, 
        status: Optional[str] = None,
        progress: Optional[int] = None,
        details: Optional[Dict[str, Any]] = None,
        error_message: Optional[str] = None
    ) -> TaskDetail:
        """更新任务详情状态和进度"""
        task_detail = self.db.query(TaskDetail).filter(TaskDetail.id == task_detail_id).first()
        if not task_detail:
            raise ValueError(f"TaskDetail with id {task_detail_id} not found")

        update_data = {}
        if status:
            update_data["status"] = status
            if status == TaskStatus.RUNNING and not task_detail.started_at:
                update_data["started_at"] = datetime.utcnow()
            elif status in [TaskStatus.COMPLETED, TaskStatus.FAILED]:
                update_data["completed_at"] = datetime.utcnow()
        
        if progress is not None:
            update_data["progress"] = progress
        
        if details:
            # 合并现有details和新details
            current_details = task_detail.details or {}
            current_details.update(details)
            update_data["details"] = current_details
        
        if error_message:
            update_data["error_message"] = error_message

        # 更新任务详情
        for key, value in update_data.items():
            setattr(task_detail, key, value)
        
        self.db.commit()
        self.db.refresh(task_detail)
        return task_detail

    def get_task_details_by_task_id(self, task_id: str) -> List[TaskDetail]:
        """获取任务的所有详情记录"""
        return self.db.query(TaskDetail).filter(TaskDetail.task_id == task_id).order_by(TaskDetail.step_order).all()

    def check_all_task_details_completed(self, task_id: str) -> bool:
        """检查任务的所有详情是否已完成"""
        task_details = self.get_task_details_by_task_id(task_id)
        if not task_details:
            return False
        
        return all(td.status == TaskStatus.COMPLETED for td in task_details)
```

### 三、更新Task服务

**位置**: `notebook-backend/app/services/task_service.py`

在现有的TaskService中添加新方法:

```python
def update_task_status_based_on_details(self, task_id: str) -> Task:
    """根据任务详情更新任务状态"""
    task = self.get_task_by_id(task_id)
    if not task:
        raise ValueError(f"Task with id {task_id} not found")

    # 获取所有task_details
    task_details = self.db.query(TaskDetail).filter(TaskDetail.task_id == task_id).all()
    if not task_details:
        return task

    # 计算总进度
    if task_details:
        completed_count = sum(1 for td in task_details if td.status == TaskStatus.COMPLETED)
        total_progress = sum(td.progress for td in task_details) / len(task_details)
        
        # 更新任务状态
        if any(td.status == TaskStatus.FAILED for td in task_details):
            # 有任何一个步骤失败，整个任务失败
            error_messages = [td.error_message for td in task_details if td.error_message]
            task.status = TaskStatus.FAILED
            task.error_message = "; ".join(error_messages)
            task.completed_at = datetime.utcnow()
        elif all(td.status == TaskStatus.COMPLETED for td in task_details):
            # 所有步骤完成，整个任务完成
            task.status = TaskStatus.COMPLETED
            task.progress = 100.0
            task.completed_at = datetime.utcnow()
        elif any(td.status == TaskStatus.RUNNING for td in task_details):
            # 有步骤在运行，整个任务在运行
            task.status = TaskStatus.RUNNING
            task.progress = total_progress
            if not task.started_at:
                task.started_at = datetime.utcnow()
    
    self.db.commit()
    self.db.refresh(task)
    return task
```

### 四、基础服务层实现

按照文档处理任务流程实现计划-服务层.md中的代码实现以下服务:

1. 存储服务（StorageService）- 已在文档中提供
2. 向量存储服务（VectorStoreService）- 已在文档中提供
3. 文本提取服务（TextExtractionService）- 已在文档中提供
4. 文本分块服务（TextSplittingService）- 已在文档中提供
5. 嵌入向量服务（EmbeddingService）- 已在文档中提供

### 五、应用配置实现

**位置**: `notebook-backend/app/config.py` - 已在文档中提供

### 六、第一阶段实施步骤

1. 实现TaskDetail数据模型及关联关系
2. 实现任务详情服务（TaskDetailService）
3. 更新任务服务（TaskService）
4. 实现各基础服务（存储、向量存储、文本提取、文本分块、嵌入向量）
5. 配置应用设置
6. 执行数据库迁移
7. 编写单元测试
8. 测试所有服务功能

### 七、测试验证

1. 测试TaskDetail模型创建和关联
2. 测试TaskDetailService的CRUD操作
3. 测试任务状态基于任务详情的更新功能
4. 测试各基础服务的独立功能
   - 文件上传和下载
   - 向量存储和检索
   - 文本提取
   - 文本分块
   - 嵌入向量生成 